<%= render Components::Window.new("Edit Identity: #{@identity.first_name} #{@identity.last_name}", close_url: backend_identity_path(@identity), max_width: 600) do %>
  <div class="padding">
    <% if @identity.errors.any? %>
      <div class="alert alert-danger">
        <h4><%= pluralize(@identity.errors.count, "error") %> prohibited this identity from being saved:</h4>
        <ul>
          <% @identity.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>
    <%= form_with model: [@identity], url: backend_identity_path(@identity), method: :patch, local: true do |f| %>
      <fieldset style="margin-bottom: 2rem;">
        <legend>Identity Information</legend>
        <div class="form-one-line">
          <%= f.label :first_name %>
          <%= f.text_field :first_name %>
        </div>
        <div class="form-one-line">
          <%= f.label :last_name %>
          <%= f.text_field :last_name %>
        </div>
        <div class="form-one-line">
          <%= f.label :legal_first_name, "Legal First Name" %>
          <%= f.text_field :legal_first_name %>
        </div>
        <div class="form-one-line">
          <%= f.label :legal_last_name, "Legal Last Name" %>
          <%= f.text_field :legal_last_name %>
        </div>
        <div class="form-one-line">
          <%= f.label :primary_email, "Email" %>
          <%= f.email_field :primary_email %>
        </div>
        <div class="form-one-line">
          <%= f.label :phone_number, "Phone Number" %>
          <%= f.telephone_field :phone_number %>
        </div>
        <div class="form-one-line">
          <%= f.label :birthday, "Date of Birth" %>
          <%= f.date_field :birthday %>
        </div>
        <div class="form-one-line">
          <%= f.label :country, "Country" %>
          <%= f.select :country, options_for_select(Identity.countries_for_select.map {|code, name| [name, code]}, @identity.country), { prompt: "Select a country" } %>
        </div>
        <div class="form-one-line">
          <%= f.label :hq_override, "HQ Override" %>
          <%= f.check_box :hq_override %>
          <small>Check this to override normal eligibility rules</small>
        </div>
        <div class="form-one-line">
          <%= f.label :ysws_eligible, "YSWS Eligible" %>
          <%= f.check_box :ysws_eligible %>
          <small>Check if eligible for YSWS</small>
        </div>
        <% super_admin_tool do %>
          <div class="form-one-line">
            <%= f.label :permabanned, "Permabanned" %>
            <%= f.check_box :permabanned %>
            <small>Check to permanently ban this identity (makes ineligible)</small>
          </div>
        <% end %>
        <div style="margin-bottom: 1.5rem;">
          <%= label_tag :reason, "Reason for Change (required)" %>
          <%= text_area_tag :reason, params[:reason], placeholder: "Please provide a detailed reason for these changes. This will be logged in the audit trail.", rows: 4 %>
          <br>
          <small>This reason will be recorded in the audit log and is required for all identity changes.</small>
        </div>
        <div class="inline-buttons" style="justify-content: flex-end;">
          <%= link_to "Cancel", backend_identity_path(@identity), class: "button" %>
          <%= f.submit "Update Identity", class: "button" %>
        </div>
      </fieldset>
    <% end %>
    <div class="lowered padding">
      <h3 style="margin-top: 0;">⚠️ Break Glass Access Required</h3>
      <p style="margin-bottom: 0;">
        This functionality requires break glass permissions. All changes will be permanently logged in the audit trail with your user information and the provided reason.
      </p>
    </div>
    <% if @identity.slack_id.present? %>
      <%= button_to "Clear Slack ID", clear_slack_id_backend_identity_path(@identity) %>
    <% else %>
      <%= button_to "Provision Slack Account", reprovision_slack_backend_identity_path(@identity) %>
    <% end %>
  </div>
<% end %>
